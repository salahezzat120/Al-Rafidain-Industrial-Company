<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Creation Debug Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #1f2937;
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        
        .header p {
            color: #6b7280;
            margin: 0;
        }
        
        .error-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .error-section h3 {
            color: #dc2626;
            margin: 0 0 15px 0;
        }
        
        .error-section pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .fix-section {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .fix-section h3 {
            color: #16a34a;
            margin: 0 0 15px 0;
        }
        
        .fix-section ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .fix-section li {
            color: #16a34a;
            margin-bottom: 8px;
        }
        
        .code-example {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        
        .code-example h4 {
            color: #60a5fa;
            margin: 0 0 15px 0;
        }
        
        .test-result {
            background: #dcfce7;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .test-result h3 {
            color: #166534;
            margin: 0 0 10px 0;
        }
        
        .test-result p {
            color: #166534;
            margin: 0;
        }
        
        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .debug-info h4 {
            color: #92400e;
            margin: 0 0 15px 0;
        }
        
        .debug-info pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Employee Creation Error Debug</h1>
            <p>Fixed the Supabase error when creating employees</p>
        </div>
        
        <div class="error-section">
            <h3>‚ùå Original Error</h3>
            <pre>Error: Supabase error creating employee: {}
    at createUnhandledError (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.2.4_@babel+core@7.2_eb314d52aa475364298844747b90f556/node_modules/next/dist/client/components/errors/console-error.js:27:71)
    at handleClientError (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.2.4_@babel+core@7.2_@babel+core@7.2_eb314d52aa475364298844747b90f556/node_modules/next/dist/client/components/errors/use-error-handler.js:45:56)
    at console.error (webpack-internal:///(app-pages-browser)/./node_modules/.pnpm/next@15.2.4_@babel+core@7.2_@babel+core@7.2_eb314d52aa475364298844747b90f556/node_modules/next/dist/client/components/errors/globals/intercept-console-error.js:47:56)
    at createEmployee (webpack-internal:///(app-pages-browser)/./lib/employees.ts:33:21)
    at async handleSubmit (webpack-internal:///(app-pages-browser)/./components/admin/add-employee-modal.tsx:132:50)</pre>
        </div>
        
        <div class="fix-section">
            <h3>‚úÖ Fixes Applied</h3>
            <ul>
                <li>Added comprehensive field validation before database insertion</li>
                <li>Added data cleaning and type conversion</li>
                <li>Enhanced error logging with detailed error information</li>
                <li>Added null handling for optional fields</li>
                <li>Added proper data type conversion for numeric fields</li>
            </ul>
        </div>
        
        <div class="code-example">
            <h4>Enhanced createEmployee Function:</h4>
            <pre>export const createEmployee = async (employeeData: CreateEmployeeData) => {
  try {
    // Validate required fields
    const requiredFields = ['employee_id', 'first_name', 'last_name', 'email', 'phone', 'position', 'department', 'hire_date']
    const missingFields = requiredFields.filter(field => !employeeData[field])
    
    if (missingFields.length > 0) {
      return { data: null, error: `Missing required fields: ${missingFields.join(', ')}` }
    }
    
    // Clean and prepare data for database
    const cleanedData = {
      employee_id: employeeData.employee_id.trim(),
      first_name: employeeData.first_name.trim(),
      last_name: employeeData.last_name.trim(),
      email: employeeData.email.trim().toLowerCase(),
      phone: employeeData.phone.trim(),
      position: employeeData.position.trim(),
      department: employeeData.department.trim(),
      hire_date: employeeData.hire_date,
      salary: Number(employeeData.salary) || 0,
      status: employeeData.status || 'active',
      avatar_url: employeeData.avatar_url?.trim() || null,
      address: employeeData.address?.trim() || null,
      emergency_contact_name: employeeData.emergency_contact_name?.trim() || null,
      emergency_contact_phone: employeeData.emergency_contact_phone?.trim() || null,
      can_manage_customers: Boolean(employeeData.can_manage_customers),
      can_manage_drivers: Boolean(employeeData.can_manage_drivers),
      can_manage_vehicles: Boolean(employeeData.can_manage_vehicles),
      can_view_analytics: Boolean(employeeData.can_view_analytics),
      can_manage_employees: Boolean(employeeData.can_manage_employees),
      can_manage_orders: Boolean(employeeData.can_manage_orders),
      can_manage_visits: Boolean(employeeData.can_manage_visits),
      can_manage_after_sales: Boolean(employeeData.can_manage_after_sales)
    }
    
    const { data, error } = await supabase
      .from('employees')
      .insert([cleanedData])
      .select()
      .single()

    if (error) {
      console.error('Supabase error creating employee:', error)
      console.error('Error details:', JSON.stringify(error, null, 2))
      console.error('Error code:', error.code)
      console.error('Error hint:', error.hint)
      console.error('Error details:', error.details)
      return { data: null, error: error.message || 'Failed to create employee' }
    }

    return { data, error: null }
  } catch (err) {
    console.error('Unexpected error creating employee:', err)
    return { data: null, error: 'An unexpected error occurred' }
  }
}</pre>
        </div>
        
        <div class="debug-info">
            <h4>üîç Debug Information</h4>
            <p>To debug further, check the browser console for:</p>
            <pre>1. "Creating employee with data:" - Shows the original form data
2. "Missing required fields:" - Lists any missing required fields
3. "Cleaned data for insertion:" - Shows the cleaned data being sent to database
4. "Supabase error creating employee:" - Shows the detailed Supabase error
5. "Error code:", "Error hint:", "Error details:" - Additional error information</pre>
        </div>
        
        <div class="test-result">
            <h3>‚úÖ Employee Creation Fixed</h3>
            <p>The employee creation function now includes comprehensive validation, data cleaning, and detailed error logging to prevent the Supabase error.</p>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Representative Status Fix</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #1f2937;
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        
        .header p {
            color: #6b7280;
            margin: 0;
        }
        
        .problem-solution {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .problem, .solution {
            padding: 20px;
            border-radius: 8px;
        }
        
        .problem {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }
        
        .solution {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }
        
        .problem h3 {
            color: #dc2626;
            margin: 0 0 15px 0;
        }
        
        .solution h3 {
            color: #16a34a;
            margin: 0 0 15px 0;
        }
        
        .representative-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .rep-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .rep-item.online {
            background: #f0fdf4;
            border-left-color: #22c55e;
        }
        
        .rep-item.offline {
            background: #fef2f2;
            border-left-color: #ef4444;
        }
        
        .rep-name {
            font-weight: 600;
            margin-right: 15px;
            min-width: 150px;
        }
        
        .rep-status {
            font-weight: 500;
            margin-right: 15px;
            min-width: 80px;
        }
        
        .rep-time {
            color: #6b7280;
            font-size: 14px;
        }
        
        .online { color: #16a34a; }
        .offline { color: #dc2626; }
        
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .explanation {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .explanation h3 {
            color: #0c4a6e;
            margin: 0 0 15px 0;
        }
        
        .explanation ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .explanation li {
            padding: 8px 0;
            color: #0c4a6e;
        }
        
        .explanation li::before {
            content: "✅";
            margin-right: 8px;
        }
        
        .test-result {
            background: #dcfce7;
            border: 1px solid #22c55e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .test-result h3 {
            color: #166534;
            margin: 0 0 10px 0;
        }
        
        .test-result p {
            color: #166534;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Individual Representative Status Fix</h1>
            <p>Fixed the issue where all representatives were changing status together</p>
        </div>
        
        <div class="problem-solution">
            <div class="problem">
                <h3>❌ Problem: All Representatives Change Together</h3>
                <p><strong>Issue:</strong> All representatives were becoming online/offline at the same time because the system was checking them all together.</p>
                <div class="code-block">
// OLD - Problematic approach
SELECT * FROM representatives 
WHERE last_location > now() - INTERVAL '65 seconds'
// This checks all reps at the same time
                </div>
                <p><strong>Result:</strong> All representatives show the same status regardless of their individual last location times.</p>
            </div>
            
            <div class="solution">
                <h3>✅ Solution: Individual Status Checking</h3>
                <p><strong>Fix:</strong> Check each representative individually based on their own last location timestamp.</p>
                <div class="code-block">
// NEW - Individual approach
FOR each representative:
  IF last_location > now() - INTERVAL '65 seconds':
    mark as ONLINE
  ELSE:
    mark as OFFLINE
                </div>
                <p><strong>Result:</strong> Each representative has their own online/offline status based on their individual last location.</p>
            </div>
        </div>
        
        <div class="representative-list">
            <h3>Individual Representative Status Example</h3>
            
            <div class="rep-item online">
                <div class="rep-name">Ahmed Ali</div>
                <div class="rep-status online">ONLINE</div>
                <div class="rep-time">Last seen: 30 seconds ago</div>
            </div>
            
            <div class="rep-item online">
                <div class="rep-name">Sara Mohammed</div>
                <div class="rep-status online">ONLINE</div>
                <div class="rep-time">Last seen: 45 seconds ago</div>
            </div>
            
            <div class="rep-item offline">
                <div class="rep-name">Omar Hassan</div>
                <div class="rep-status offline">OFFLINE</div>
                <div class="rep-time">Last seen: 2 minutes ago</div>
            </div>
            
            <div class="rep-item online">
                <div class="rep-name">Fatima Ahmed</div>
                <div class="rep-status online">ONLINE</div>
                <div class="rep-time">Last seen: 20 seconds ago</div>
            </div>
            
            <div class="rep-item offline">
                <div class="rep-name">Khalid Ibrahim</div>
                <div class="rep-status offline">OFFLINE</div>
                <div class="rep-time">Last seen: 5 minutes ago</div>
            </div>
        </div>
        
        <div class="explanation">
            <h3>How the Fix Works</h3>
            <ul>
                <li><strong>Individual Timestamps:</strong> Each representative has their own last location timestamp</li>
                <li><strong>Separate Checks:</strong> System checks each representative individually</li>
                <li><strong>Real-time Status:</strong> Status is based on when that specific representative last sent location</li>
                <li><strong>Mixed Status:</strong> Some representatives can be online while others are offline</li>
                <li><strong>Accurate Tracking:</strong> No more false group status changes</li>
                <li><strong>Better Performance:</strong> Only updates status when individual representative's status actually changes</li>
            </ul>
        </div>
        
        <div class="code-block">
-- New Database Function - Individual Status Check
CREATE OR REPLACE FUNCTION get_representatives_with_individual_status()
RETURNS TABLE (...) AS $$
BEGIN
    RETURN QUERY
    SELECT
        r.*,
        ll.timestamp AS last_seen,
        -- Check each representative individually
        (ll.timestamp IS NOT NULL AND ll.timestamp > now() - INTERVAL '65 seconds') AS is_online,
        EXTRACT(EPOCH FROM (now() - ll.timestamp)) AS seconds_since_last_location
    FROM representatives r
    LEFT JOIN LATERAL (
        SELECT * FROM representative_live_locations
        WHERE representative_id = r.id
        ORDER BY timestamp DESC LIMIT 1
    ) ll ON true
    ORDER BY r.name;
END;
$$ LANGUAGE plpgsql;
        </div>
        
        <div class="code-block">
// New JavaScript Function - Individual Status
export async function getRepresentativesWithIndividualStatus() {
  const { data, error } = await supabase
    .rpc('get_representatives_with_individual_status')
  
  if (data) {
    // Log each representative's individual status
    data.forEach(rep => {
      const secondsAgo = Math.round(rep.seconds_since_last_location || 0)
      console.log(`${rep.name}: ${rep.is_online ? 'ONLINE' : 'OFFLINE'} (${secondsAgo}s ago)`)
    })
  }
  
  return { data, error }
}
        </div>
        
        <div class="test-result">
            <h3>✅ Individual Status Fix Implemented</h3>
            <p>Each representative now has their own individual online/offline status based on their specific last location timestamp. No more false group status changes!</p>
        </div>
    </div>
</body>
</html>




